# autorepeater

Автоповторитель действий по одному из ваших брокерских счетов в другом вашем брокерском счёте.

## Принцип работы

Работаем с двумя счетами - счёт источник и счёт на котором повторяем действия (счёт назначения). По счёту источнику отслеживаем любые движения по акциям и фондам (проверял только их, но возможно будет работать и с другими инструментами), движения по валютам - игнорируются. По счёту назначения - отслеживаем наоборот, только действия с валютой (проверял на пополнениях, выводить в теории тоже можно, но для повторения действий - это не имеет смысла). При получении отслеживаемых триггеров по одному из счетов - запускаем их синхронизацию.

Синхронизация заключается в том, что сначала мы рассчитываем общую стоимость по всем позициям счёта источника за исключением валют, валюты не учитываю, что бы в расчёте не участвовал резерв для оплаты комиссий. Потом расчитываем общую стоимость всех позиций по счёту назначения, включая валюты. И вычитаем 0.5% резерва на комиссии и округления. (величина резерва подобрана эмпирически)
На основании общих стоимостей рассчитывается соотношение между счетами, а из этого соотношения и позиций счёта источника рассчитывается целевое состояние счёта. Целевое состояние счёта не обязательно кратно лотности и даже может содержать дробные значения позиций, оно просто отображает идеальное состояние счёта, которое скорее всего недостижимо
Вычисляется разница в лотах между целевым и текущим состоянием счёта назначения, она округляется до ближайшего целого количества лотов.
Если разница отлична от 0, то ставится заявка на покупку или продажу по лучшей цене.
Сначала ставятся все заявки на продажу, что бы освободить средства на покупку, потом все заявки на покупку.

## Для чего
У Т-инвестиций есть механизм автоследования. Если абстрагироваться от вопросов доверия к конкретным авторам стратегий, то у всех стратегий есть общая проблема - чрезмерно высокая комиссия за следование. 
Комиссия за результат зависит от результата и по сути просто уменьшает на определённый процент возможный доход, а вот комиссия за следование снимается постоянно, в любых условиях и в долгосрочной перспективе может съесть значительный процент дохода для стратегий с высокой доходностью и даже привести к отрицательной доходности для стратегий с пусть небольшой, но всё же положительной доходностью.

Тут мы частично решаем эту проблему уменьшая комиссии. Если счёт источник - сделать счётом для автоследования и положить на него минимальную необходимую сумму, а счётом назначения указать тот счёт, на котором планируется держать основные средства для стратегии, то на выходе мы получим работающее автоследование с минимизацией комиссий.

## Возможные подводные камни
 - За операции по основному счёту будут взыматься стандартные комиссии. В большинстве случаев для средне и долгосрочных стратегий в которых операции совершаются не каждый день - эти комиссии значительно ниже, чем комиссия за следование + нет комиссии за результат, но в частных случаях могут быть перекосы, когда дешевле заплатить комиссию за следование.

 - Стратегии на которых я проверял - работают только с акциями и фондами. В теории могут работать и стратегии с другими инструментами, но это на свой страх и риск

  - У меня на брокерских счетах лежат только рубли и инструменты в стратегиях только рублёвые. Вероятно, если в стратегии появятся инструменты с разными валютами и на счёте будет лежать несколько валют, то что-то сломается. Как минимум не реализована покупка и продажа валют

  ## TODO
  Код написан на коленке, по принципу "и так сойдёт", со временем я его причешу. Нет обработки ошибок.
